#!/usr/bin/env bash
# @file
# Build a stand-alone web services (REST) client application.

echo "Building the FolderShare web services (REST) client application"

#
# Define names.
#
appFile='foldershare'
sourceDir="src"
sourceFiles="FolderShareConnect.php FolderShareFormat.php foldershare.php"
scriptFile='script$$.tmp'

#
# Create SED script to remove source lines that don't belong when
# the source is bundled together. This includes:
# - The header <?php
# - Namespace declarations.
# - Use statements for files we're including in the bundle.
# - Require statements for files we're including in the bundle.
#
echo "  Setup..."
cat <<EOF > $scriptFile
/^<\?php/d
/^namespace/d
/^use FolderShare/d
/^.*require \"FolderShare/d
EOF

#
# Bundle the source files into a new stand-alone PHP file.
#
echo "  Build..."
cat <<EOF > $appFile
#!/usr/bin/env php
<?php
/**
 * @file
 * The FolderShare web services (REST) client application.
 *
 * DO NOT EDIT THIS FILE!
 *
 * This file has been built automatically by concatenating a set of
 * separate source files in order to create a single stand-alone
 * application. If you need to modify this application, you should
 * edit the source files instead, then re-concatenate them into a
 * new application.
 *
 * This file contains the following source files:
EOF
for f in $sourceFiles; do
    echo " *   $sourceDir/$f" >> $appFile
done
echo " *" >> $appFile
echo " * Built on: `date`" >> $appFile
echo " */" >> $appFile

for f in $sourceFiles; do
    sed -f $scriptFile $sourceDir/$f >> $appFile
done

#
# Clean up. Remove the SED script and make the bundle executable.
rm -f $scriptFile
chmod ugo+x $appFile

echo "  Done."
echo
echo "The client application is ready and named '$appFile'."
echo "It may be copied or moved out of this directory and installed anywhere."
echo
echo "Type '$appFile --help' for a description of its use."
